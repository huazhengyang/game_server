***
# <center> 服务端架构说明
***
# 服务器结构

## 结构图

![未命名文件-2](/Users/huazhengyang/Downloads/未命名文件-2.png)

## 说明

> + 用户从sdk获取网关的IP地址，并建立连接登录到网关
> + 网关及各场景服务器间通信通过redis消息队列进行通信
> + 数据存储，热数据使用redis。冷数据使用mongodb
> + 所有服务器不向外暴露ip，通过HAproxy反向代理访问
> + 负载均衡由mother服务定时向sdk服务器同步，用户连接时会获取到一个负载较低的网关服务器连接  
> + 对于单点部署的服务最低要做到主备部署，后续要做到平行扩容



## 服务器功能说明

> + sdk负责用户注册、检查用户登录、充值、广告、统计等功能
> + gate网关负责维护与用户的网络连接、及用户与逻辑服务器组的交互、网络攻击缓冲
> + hall大厅负责用户房间选择，好友，邮件，商店等功能
> + game场景服务器，即游戏服务器，承载各游戏的逻辑实现
> + mother负责服务发现、各服务器状态维护
> + 除去sdk服务器，各服务间使用redis消息队列进行通信



# 服务器逻辑架构

## sdk服务器

![sdk服务器架构图](/Users/huazhengyang/Downloads/sdk服务器架构图.png)

### 说明

> + sdk服务器由上至下分为4个逻辑层：网络接口、业务核心、数据基础、基础库
> + 网络接口负责网络通信，使用http协议
> + 业务核心负责各个业务模块的实现
> + 数据基础层负责玩家数据存储
> + 基础库为服务器提取的核心功能组件，是所有服务器的基础



## 网关服务器

![网关服务器架构图](/Users/huazhengyang/Downloads/网关服务器架构图.png)



### 说明

> + 网关由上至下也分为四层，分别是接口层、业务层、消息转发、和基础库
> + 网关服务器的结构也类似于mvc架构
> + 接口层负责网络连接传输
> + 业务层负责业务逻辑实现，主要有消息模块、安全模块、连接管理等
> + 消息转发使用redis的发布订阅模式做为消息队列



## 棋牌服务器

![棋牌服务器架构图-3](/Users/huazhengyang/Downloads/棋牌服务器架构图-3.png)

### 说明

> + 棋牌游戏服务器分为hall进程、game进程、mother进程，所有服务器进程通过消息队列与网关服务交互
> + 棋牌服务器所用到的业务库有，基础业务库、游戏规则库、游戏业务库
> + 基础业务库，包括游戏中除玩法规则之外的游戏业务，包括物品、好友、活动、邮件、商城等等，还包括一些游戏业务的基类，比如任务基类可以派生出不同游戏的任务。
> + 游戏规则库，包括所有游戏的玩法，或者可以拆分为更细的规则，比如德州可以拆分为开始规则(人满开始、大于两个)、货币规则(真金、虚拟货币)、游戏规则，通过不同规则的组合出不同的玩法
> + 游戏业务库，包括各个游戏中特有的游戏业务，比如，斗地主任务，德州任务，斗地主比赛规则等等
> + 游戏插件化，所有的游戏只需将源代码拷贝到指定的目录即可启动运行。
> + 功能插件化，做到每个功能为一个独立的单元，可进行热插拔



# 理想中的服务器架构

![游戏服务器架构图-2](/Users/huazhengyang/Downloads/游戏服务器架构图-2.png)

## 说明

> + 服务器架构的最终版本，只做游戏框架开发，框架包含特殊的游戏机制，比如帧同步、mmo中的地图视野等，其他功能全部组件化、通过配置添加不同的组件，组合成基本的游戏世界。
> + 快速开发，减少重复造轮子的工作，如果缺少玩法模块就添加玩法模块，加入到游戏规则库中。
> + 低耦合高聚合，模块间减少耦合，可以同步快速开发。



# 补充

游戏前期主要是搭建游戏框架、开发游戏功能，所以日志分析及bi分析系统可以使用市面上的第三方或者是开源的软件，等待后面的业务增长了，考虑搭建自己的日志分析和bi分析系统。